#!/bin/bash

#-----------
# Configurations
#-----------

NGINX_SITES_ENABLED_DIR=${NGINX_SITES_ENABLED_DIR-/etc/nginx/sites-enabled}
NGINX_LOG_DIR=${NGINX_LOG_DIR-/var/log/nginx}
NGINX_HTTP_PORT=${NGINX_HTTP_PORT-80}
NGINX_SSL_PORT=${NGINX_SSL_PORT-443}
NGINX_APPS_DIR=${NGINX_APPS_DIR-/var/apps}

NGINX_INCLUDE_PHP=${NGINX_INCLUDE_PHP-true}

#-----------
# Install Script
#-----------

mkdir -p /var/apps/nginx
mkdir -p /var/apps/nginx/startup.d
mkdir -p $NGINX_SITES_ENABLED_DIR

cp ./submodules/nginx/files/nginx.dockerfile /var/apps/nginx/Dockerfile

if [[ "$NGINX_INCLUDE_PHP" = true ]]; then
  sed -i 's|# @PHP_INSTALL@|cat ./submodules/nginx/files/php_partial.dockerfile|e' /var/apps/nginx/Dockerfile
  printf '#!/bin/bash\n/etc/init.d/php5-fpm restart\n' > /var/apps/nginx/startup.d/php5_fpm
  chmod 755 /var/apps/nginx/startup.d/php5_fpm
else
  printf '#!/bin/bash\n# Do nothing\n' > /var/apps/nginx/startup.d/empty
  chmod 755 /var/apps/nginx/startup.d/empty
  rm -f /var/apps/nginx/startup.d/php5_fpm
fi

(cd /var/apps/nginx && docker build -t nginx .)
echo "docker run -i -t nginx /bin/bash" > /var/apps/nginx/console

echo "docker run -i -t nginx /etc/init.d/nginx reload" > /var/apps/nginx/reload
echo "docker run -i -t nginx /etc/init.d/nginx restart" > /var/apps/nginx/restart
echo "docker run -d -p $NGINX_HTTP_PORT:80 -p $NGINX_SSL_PORT:443 -v $NGINX_APPS_DIR:/var/apps -v $NGINX_SITES_ENABLED_DIR:/etc/nginx/sites-enabled -v $NGINX_LOG_DIR:/var/log/nginx nginx" > /var/apps/nginx/daemon
cp ./submodules/nginx/files/idempot /var/apps/nginx/idempot
cp ./submodules/nginx/files/console /var/apps/nginx/console

chmod 755 /var/apps/nginx/console
chmod 755 /var/apps/nginx/reload
chmod 755 /var/apps/nginx/restart
chmod 755 /var/apps/nginx/daemon
chmod 755 /var/apps/nginx/idempot
